<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>動詞学習ゲーム</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 0; }
    .image-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px; }
    .image-button { position: relative; border: 2px solid transparent; cursor: pointer; }
    .image-button.selected { border: 2px solid red; }
    .checkmark { position: absolute; top: 5px; right: 5px; font-size: 24px; color: red; display: none; }
    .image-button.selected .checkmark { display: block; }

    /* 入力用オーバーレイ（既存） */
    #overlay { position: fixed; inset: 0; width: 100%; height: 100%; background: rgba(200,200,200,0.8); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 20; }
    #counter { font-size: 48px; }

    #input-section { margin-top: 20px; }
    img { pointer-events: none; user-select: none; }
    #today-section { margin: 16px 20px; text-align: left; }
    #today-title { font-weight: 700; margin-bottom: 8px; }
    #today-list { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 768px){ #today-list { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    .today-row { display: grid; grid-template-columns: 110px 1fr; gap: 12px; align-items: center; background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 8px; }
    .today-left { display: flex; align-items: center; justify-content: center; }
    .today-left img { width: 100%; height: auto; max-height: 80px; object-fit: contain; }
    .pair-line { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .tag { font-size: 0.9em; color: #555; }
    .play { padding: 6px 10px; font-size: 14px; }
    table { border-collapse: collapse; width: 100%; font-size: 0.9em; }
    th, td { border-bottom: 1px solid #eee; padding: 6px 4px; text-align: center; }
    input, textarea, select, button { font-size: 16px; }
    #text-input { width: 80vw; max-width: 420px; }

    #toast { position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); background: rgba(0,0,0,0.78); color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 14px; display: none; z-index: 40; }
  </style>
  <script>
    document.addEventListener('contextmenu', e => e.preventDefault());
  </script>
</head>
<body>
  <h1>動詞学習ゲーム</h1>
  <div id="intro-image" style="margin-top: 20px;">
    <img src="image/image-00.png" alt="例示画像" style="width:60%; max-width:300px;" />
    <p style="font-size: 1.2em; margin-top: 10px;">学籍番号を入力してください</p>
  </div>

  <div id="start-section">
    学籍番号: <input type="text" id="student-id" maxlength="8" />
    <button onclick="startGame()">スタート</button>
  </div>

  <div id="today-section">
    <div id="today-title">今日の動詞</div>
    <div id="today-list"></div>
  </div>

  <div id="game-info" style="display:none">
    <p id="turn-info"></p>
    <p id="score-info"></p>
  </div>

  <div class="image-grid" id="image-grid"></div>

  <button id="listen-button" style="display:none" onclick="__replayCurrent()">もう一度聞く</button>
  <button id="confirm-button" style="display:none" onclick="confirmSelection()">OK</button>

  <div id="overlay">
    <div id="counter">10</div>
    <div>je の活用を書いてください</div>
    <div id="input-section">
      <input type="text" id="text-input" value="" onkeydown="if(event.key==='Enter'){submitAnswer();}"/>
      <button onclick="submitAnswer()">OK</button>
    </div>
  </div>

  <div id="result" style="display:none"></div>
  <div id="toast"></div>

  <audio id="audio-player" src="audio.mp3" preload="auto" playsinline></audio>
  <audio id="audio-re-player" src="audioRe.mp3" preload="auto" playsinline></audio>

  <script src="./js/a1.js"></script>
  <script src="./js/b2.js"></script>
  <script src="./js/r4.js"></script>
  <script src="./js/c3.js"></script>

  <script>
    // ===== 設定を一元管理 =====
    const BUFFER = Object.freeze({
      DELAY_MS: 1500,              // 再生までの固定ディレイ（暗転なし運用）
      READY_STATE: 3,              // HAVE_FUTURE_DATA
      TIMEOUT_MS: 1500,            // バッファ待ちの上限
      SEEK_SETTLE_MS: 180,         // シーク直後の馴染み待ち
      EXTRA_START_MS: 100,         // 最後のひと呼吸
      START_WATCHDOG_MS: 1400      // 開始できないときの早期解放
    });

    // もし授業中に即席で調整したい場合の簡易API（任意）
    window.setBufferDelay = (ms)=>{ BUFFER.DELAY_MS = ms; };

    let _origViewportContent = null;
    function lockZoom(){ const m = document.querySelector('meta[name="viewport"]'); if(!m) return; const c = m.getAttribute('content')||'width=device-width, initial-scale=1.0'; if(_origViewportContent==null) _origViewportContent=c; if(!/maximum-scale/.test(c)) m.setAttribute('content', c + ', maximum-scale=1, user-scalable=no'); }
    function unlockZoom(){ const m = document.querySelector('meta[name="viewport"]'); if(m && _origViewportContent!=null) m.setAttribute('content', _origViewportContent); }

    const maxVerbe = 10;
    const formsURL = "https://forms.office.com/";
    const segmentMap = {"01a":0,"01b":5,"02a":10,"02b":15,"03a":20,"03b":25,"04a":30,"04b":35,"05a":40,"05b":45,"06a":50,"06b":55,"07a":60,"07b":65,"08a":70,"08b":75,"09a":80,"09b":85,"10a":90,"10b":95,"11a":100,"11b":105,"12a":110,"12b":115,"13a":120,"13b":125,"14a":130,"14b":135,"15a":140,"15b":145,"16a":150,"16b":155,"17a":160,"17b":165,"18a":170,"18b":175,"19a":180,"19b":185,"20a":190,"20b":195};

    const COUNTDOWN_SEC = 10;

    const responses = window.responses || {};
    let turn = 0, score = 0;
    let selectedImage = "", correctAnswer = "", correctImage = "";
    let countdown, studentId = "", currentAudioId = "";
    let history = [];

    const lastHandlers = {'audio-player': null,'audio-re-player': null};
    const playingLocks = {'audio-player': false,'audio-re-player': false};
    const sessionTokens = {'audio-player': null,'audio-re-player': null};
    let inGame = false;

    function showToast(msg){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.style.display='block'; clearTimeout(t._hideTimer); t._hideTimer=setTimeout(()=>{ t.style.display='none'; }, 1300); }

    function detachLastHandlers(audio, id){ const h=lastHandlers[id]; if(!h) return; try{audio.removeEventListener('timeupdate',h.onTime);}catch(e){} try{audio.removeEventListener('seeked',h.onSeeked);}catch(e){} try{audio.removeEventListener('loadedmetadata',h.onMeta);}catch(e){} try{audio.removeEventListener('loadeddata',h.onLoadedData);}catch(e){} try{audio.removeEventListener('canplay',h.onCanPlay);}catch(e){} try{audio.removeEventListener('playing',h.onPlaying);}catch(e){} lastHandlers[id]=null; }

    function stopOtherAudios(activeId){ ['audio-player','audio-re-player'].forEach(id=>{ if(id!==activeId){ const el=document.getElementById(id); if(el){ el.pause(); try{ el.currentTime=0; }catch(e){} detachLastHandlers(el,id);} playingLocks[id]=false; sessionTokens[id]=null; } }); }

    function attemptPlay(audio, attemptsLeft=3, delay=100){ const p=audio.play(); if(p && typeof p.catch==='function'){ p.catch(()=>{ if(attemptsLeft>0){ setTimeout(()=>attemptPlay(audio, attemptsLeft-1, delay), delay); } }); } }

    function waitForReady(audio, targetState=BUFFER.READY_STATE, timeout=BUFFER.TIMEOUT_MS){ return new Promise(resolve=>{ if(audio.readyState>=targetState) return resolve(true); const onLoadedData=()=>{ if(audio.readyState>=targetState) done(true); }; const onCanPlay=()=>{ if(audio.readyState>=targetState) done(true); }; const to=setTimeout(()=>done(false), timeout); function done(ok){ try{audio.removeEventListener('loadeddata',onLoadedData);}catch(e){} try{audio.removeEventListener('canplay',onCanPlay);}catch(e){} clearTimeout(to); resolve(ok);} audio.addEventListener('loadeddata',onLoadedData); audio.addEventListener('canplay',onCanPlay); }); }

    // 共通: 固定ディレイ後に再生
    function playAfterDelay(playerId, segmentId, durationSec=5, opts={}, delayMs=BUFFER.DELAY_MS){ setTimeout(()=>{ playSegment(playerId, segmentId, durationSec, opts); }, delayMs); }

    function playSegment(playerId, segmentId, durationSec=5, opts={}){
      const { reset=false } = opts;
      const audio=document.getElementById(playerId);
      const startTime=segmentMap[segmentId];
      if(!audio || startTime===undefined) return;
      const token=Symbol(); sessionTokens[playerId]=token;
      if(playingLocks[playerId]) return; playingLocks[playerId]=true;
      stopOtherAudios(playerId); detachLastHandlers(audio, playerId);

      const endTime=startTime+durationSec; let started=false;
      const onTime=()=>{ if(audio.currentTime>=endTime){ cleanup(true); } };
      const startAfterSeek=async()=>{
        if(sessionTokens[playerId]!==token) return;
        await new Promise(r=>setTimeout(r, BUFFER.SEEK_SETTLE_MS));
        await waitForReady(audio);
        await new Promise(r=>setTimeout(r, BUFFER.EXTRA_START_MS));
        if(sessionTokens[playerId]!==token) return;
        attemptPlay(audio,3);
      };
      const onSeeked=()=>{ startAfterSeek(); };
      const onMeta=()=>{ if(sessionTokens[playerId]===token){ try{ audio.currentTime=startTime; }catch(e){} } };
      const onLoadedData=()=>{}; const onCanPlay=()=>{};
      const onPlaying=()=>{ if(sessionTokens[playerId]===token){ started=true; clearTimeout(startWatchdog); } };

      function cleanup(unlock){ try{audio.pause();}catch(e){} try{audio.currentTime=endTime;}catch(e){} detachLastHandlers(audio, playerId); if(unlock) playingLocks[playerId]=false; try{clearTimeout(fallbackTimer);}catch(e){} try{clearTimeout(startWatchdog);}catch(e){} }

      audio.pause();
      audio.addEventListener('timeupdate', onTime);
      audio.addEventListener('seeked', onSeeked);
      audio.addEventListener('loadedmetadata', onMeta);
      audio.addEventListener('loadeddata', onLoadedData);
      audio.addEventListener('canplay', onCanPlay);
      audio.addEventListener('playing', onPlaying);
      lastHandlers[playerId]={ onTime,onSeeked,onMeta,onLoadedData,onCanPlay,onPlaying };

      const fallbackTimer=setTimeout(()=>{ cleanup(true); }, (durationSec*1000)+1000);
      const startWatchdog=setTimeout(()=>{ if(!started){ cleanup(true); showToast('読み込み中です。もう一度押してください'); } }, BUFFER.START_WATCHDOG_MS);

      if(reset){ audio.load(); } else { if(audio.readyState>=1){ try{ audio.currentTime=startTime; }catch(e){ audio.load(); } } else { audio.load(); } }
    }

    // 質問側：毎回固定ディレイ
    function playAudioSegment(segmentId, reset=false){ currentAudioId=segmentId; playAfterDelay('audio-player', segmentId, 5, { reset }, BUFFER.DELAY_MS); }
    function __replayCurrent(){ if(!currentAudioId){ showToast('音声が未設定です'); return; } playAfterDelay('audio-player', currentAudioId, 5, { reset:false }, BUFFER.DELAY_MS); }

    // レビュー側：ゲーム中はブロック／結果画面は固定ディレイ
    function playReviewSegment(segmentId, reset=false){ if(inGame){ showToast('ゲーム中は質問音声のみ再生できます'); return; } playAfterDelay('audio-re-player', segmentId, 5, { reset }, BUFFER.DELAY_MS); }

    function renderTodayVerbs(){ const container=document.getElementById('today-list'); if(!container) return; container.innerHTML=''; for(let n=1;n<=maxVerbe;n++){ const idx=String(n).padStart(2,'0'); const aId=`${idx}a`, bId=`${idx}b`; const row=document.createElement('div'); row.className='today-row'; const left=document.createElement('div'); left.className='today-left'; const img=document.createElement('img'); img.src=`image/image-${idx}.png`; img.alt=`image/image-${idx}`; left.appendChild(img); const right=document.createElement('div'); const mk=(label,handler,id)=>{ const line=document.createElement('div'); line.className='pair-line'; const span=document.createElement('span'); span.className='tag'; span.textContent=label; const btn=document.createElement('button'); btn.className='play'; btn.textContent='▶'; btn.onclick=()=>handler(id); line.appendChild(span); line.appendChild(btn); return line; }; right.appendChild(mk(`oui質問`, playAudioSegment, aId)); right.appendChild(mk(`oui答え`, playReviewSegment, aId)); right.appendChild(mk(`non質問`, playAudioSegment, bId)); right.appendChild(mk(`non答え`, playReviewSegment, bId)); row.appendChild(left); row.appendChild(right); container.appendChild(row); } }

    window.addEventListener('DOMContentLoaded', ()=>{ renderTodayVerbs(); const a=document.getElementById('audio-player'); const ar=document.getElementById('audio-re-player'); if(a) a.load(); if(ar) ar.load(); });

    function startGame(){ inGame=true; studentId=document.getElementById('student-id').value; if(studentId.length<4){ alert('学籍番号の下4桁を入力してください。'); inGame=false; return; } document.getElementById('start-section').style.display='none'; document.getElementById('intro-image').style.display='none'; document.getElementById('today-section').style.display='none'; document.getElementById('game-info').style.display='block'; nextTurn(); setTimeout(()=>{ if(currentAudioId) playAudioSegment(currentAudioId); }, 0); }

    function nextTurn(){ try{clearInterval(countdown);}catch(e){} selectedImage=''; correctAnswer=''; correctImage=''; currentAudioId=''; turn++; document.getElementById('turn-info').innerText=`${turn}ターン目`; document.getElementById('score-info').innerText=`スコア：${score}/10`; document.getElementById('image-grid').innerHTML=''; document.getElementById('listen-button').style.display='none'; document.getElementById('confirm-button').style.display='none'; let indices=[]; while(indices.length<6){ let num=Math.floor(Math.random()*maxVerbe)+1; let str=num.toString().padStart(2,'0'); if(!indices.includes(str)) indices.push(str); } correctImage=indices[Math.floor(Math.random()*6)]; let suffix=Math.random()<0.5?'a':'b'; currentAudioId=`${correctImage}${suffix}`; correctAnswer=responses[currentAudioId]||''; indices.forEach(idx=>{ let img=document.createElement('img'); img.src=`image/image-${idx}.png`; img.style.width='100%'; let div=document.createElement('div'); div.className='image-button'; div.onclick=()=>{ if(selectedImage===idx){ confirmSelection(); } else { selectImage(idx); } }; let check=document.createElement('div'); check.className='checkmark'; check.innerText='✓'; div.appendChild(img); div.appendChild(check); document.getElementById('image-grid').appendChild(div); }); setTimeout(()=>{ if(currentAudioId) playAudioSegment(currentAudioId); }, 0); document.getElementById('listen-button').style.display='inline'; }

    function selectImage(idx){ selectedImage=idx; document.querySelectorAll('.image-button').forEach(div=>div.classList.remove('selected')); const btns=document.querySelectorAll('.image-button'); const imgs=document.querySelectorAll('.image-button img'); const i=Array.from(imgs).findIndex(img=>img.src.includes(`image/image-${idx}.png`)); if(i>=0) btns[i].classList.add('selected'); document.getElementById('confirm-button').style.display='inline'; }

    function confirmSelection(){ document.querySelectorAll('.image-button').forEach(div=>div.onclick=null); document.getElementById('overlay').style.display='flex'; lockZoom(); document.getElementById('text-input').value=''; document.getElementById('text-input').focus(); let counter=COUNTDOWN_SEC; document.getElementById('counter').innerText=counter; countdown=setInterval(()=>{ counter--; document.getElementById('counter').innerText=counter; if(counter<=0){ clearInterval(countdown); submitAnswer(); } }, 1000); }

    function submitAnswer(){ clearInterval(countdown); let input=document.getElementById('text-input').value.trim().toLowerCase(); input=input.replace(/’/g, "'"); document.getElementById('overlay').style.display='none'; unlockZoom(); history.push({ turn, image: correctImage, chosenImage: selectedImage, audioId: currentAudioId, correct: correctAnswer, user: input, isCorrect: (selectedImage===correctImage && input===correctAnswer) }); if(selectedImage===correctImage && input===correctAnswer) score++; if(history.length<10){ nextTurn(); } else { endGame(); } }

    function recomputeScoreFromHistory(){ score=history.filter(h=>h.isCorrect).length; const scoreInfo=document.getElementById('score-info'); if(scoreInfo) scoreInfo.innerText=`スコア：${score}/10`; }

    function endGame(){ inGame=false; recomputeScoreFromHistory(); const listenBtn=document.getElementById('listen-button'); const confirmBtn=document.getElementById('confirm-button'); if(listenBtn){ listenBtn.style.display='none'; listenBtn.onclick=null; } if(confirmBtn){ confirmBtn.style.display='none'; confirmBtn.onclick=null; } const grid=document.getElementById('image-grid'); if(grid){ grid.innerHTML=''; grid.style.display='none'; } const gi=document.getElementById('game-info'); if(gi){ gi.style.display='none'; } document.getElementById('overlay').style.display='none'; unlockZoom(); ['audio-player','audio-re-player'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.pause(); try{ el.currentTime=0; }catch(e){} detachLastHandlers(el, id); } playingLocks[id]=false; sessionTokens[id]=null; }); const sidLast4=parseInt(studentId.slice(-4),10); const finalPassword=window.computePassword(sidLast4, score); const result=document.getElementById('result'); result.style.display='block'; result.innerHTML=`<p>スコア：${score}/10</p><p>パスワード：${finalPassword}</p><button onclick="copyPassword('${finalPassword}')">コピー</button><p>コピーしたパスワードを Forms から提出してください</p><button onclick="window.open('${formsURL}', '_blank')">提出する</button>`; let historyHtml=`<table><tr><th>問題</th><th>動詞</th><th>選んだ動詞</th><th>質問</th><th>選んだ動詞の音声</th><th>正解音声</th><th>あなたの答え</th><th>正解</th><th>正誤</th></tr>`; history.forEach(h=>{ const suffix=h.audioId.slice(-1); const chosenQ=`${h.chosenImage}${suffix}`; historyHtml+=`<tr><td>${h.turn}</td><td><img src="image/image-${h.image}.png" alt="correct-${h.image}" style="width:72px;height:auto;"></td><td><img src="image/image-${h.chosenImage}.png" alt="chosen-${h.chosenImage}" style="width:72px;height:auto;"></td><td><button onclick=\"this.disabled=true; setTimeout(()=>this.disabled=false,5200); playAudioSegment('${h.audioId}', true);\">▶</button></td><td><button onclick=\"this.disabled=true; setTimeout(()=>this.disabled=false,5200); playAudioSegment('${chosenQ}', true);\">▶</button></td><td><button onclick=\"this.disabled=true; setTimeout(()=>this.disabled=false,5200); playReviewSegment('${h.audioId}', true);\">▶</button></td><td>${h.user}</td><td>${h.correct}</td><td>${h.isCorrect?'✅':'❌'}</td></tr>`; }); historyHtml+='</table>'; result.innerHTML+=historyHtml; }

    function copyPassword(pw){ navigator.clipboard.writeText(pw); alert('パスワードをコピーしました。'); }

    // window 公開
    window.startGame = startGame; window.playAudioSegment = playAudioSegment; window.playReviewSegment = playReviewSegment; window.confirmSelection = confirmSelection; window.submitAnswer = submitAnswer; window.__replayCurrent = __replayCurrent;
  </script>
</body>
</html>
